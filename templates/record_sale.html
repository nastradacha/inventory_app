{% extends 'base.html' %}
{% block content %}
<h2>Record Sale</h2>
<form method="post" class="row g-3" novalidate id="sale-form">
  {{ form.hidden_tag() }}
  
  <!-- Product search field with stock indicator -->
  <div class="col-md-6">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <label class="form-label">Product</label>
      <div>
        <span id="stock-indicator" class="badge bg-info d-none">
          Stock: <span id="stock-count">0</span>
        </span>
        <span id="price-indicator" class="badge bg-secondary d-none ms-2">
          Price: {{ currency }}<span id="list-price">0.00</span>
        </span>
      </div>
    </div>
    <select id="product-search" name="product_id" class="form-select" style="width:100%">
      <!-- Options will be loaded dynamically -->
    </select>
    {% if form.product_id.errors %}
      <div class="text-danger small">{{ form.product_id.errors[0] }}</div>
    {% endif %}
  </div>
  
  <!-- Quantity field with validation -->
  <div class="col-md-6">
    <div class="d-flex justify-content-between align-items-center mb-1">
      {{ form.quantity.label(class_='form-label') }}
      <div id="max-quantity-hint" class="text-muted small d-none">
        Max: <span id="max-quantity">0</span>
      </div>
    </div>
    {{ form.quantity(class_='form-control') }}
    {% if form.quantity.errors %}
      <div class="text-danger small">{{ form.quantity.errors[0] }}</div>
    {% endif %}
    <div id="quantity-error" class="text-danger small mt-1 d-none">
      Not enough stock!
    </div>
  </div>

  <!-- Sale date (allow backdating, not future) -->
  <div class="col-md-6">
    <div class="d-flex justify-content-between align-items-center mb-1">
      {{ form.sale_date.label(class_='form-label') }}
      <div class="text-muted small">No future dates</div>
    </div>
    {{ form.sale_date(class_='form-control', max=today, **{'data-testid':'sale-date'}) }}
    {% if form.sale_date.errors %}
      <div class="text-danger small">{{ form.sale_date.errors[0] }}</div>
    {% endif %}
  </div>

  <!-- Optional alternate unit price -->
  <div class="col-md-6">
    <div class="d-flex justify-content-between align-items-center mb-1">
      {{ form.unit_price.label(class_='form-label') }}
      <div class="text-muted small">Leave blank to use list price</div>
    </div>
    <div class="input-group">
      <span class="input-group-text">{{ currency }}</span>
      {{ form.unit_price(class_='form-control', step='0.01', min='0.01', placeholder='Leave blank to use list price', **{'data-testid':'alt-price'}) }}
    </div>
    {% if form.unit_price.errors %}
      <div class="text-danger small">{{ form.unit_price.errors[0] }}</div>
    {% endif %}
    <div id="below-cost-alert" class="text-danger small mt-1 d-none">Below cost</div>
  </div>

  <div class="col-12">
    <button class="btn btn-primary" id="submit-btn" data-testid="sell"><span class="spinner-border spinner-border-sm d-none me-1" role="status" aria-hidden="true"></span> Record</button>
  </div>
</form>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
  const currencySymbol = {{ currency|tojson }};
  const canOverrideBelowCost = {{ (current_user.is_authenticated and current_user.role == 'manager') | tojson }};
  let currentCost = null;
  let currentListPrice = null;
  // Initialize Select2 with AJAX search
  const productSelect = $('#product-search');
  productSelect.select2({
    placeholder: 'Search for product...',
    minimumInputLength: 1,
    ajax: {
      url: '{{ url_for("search_products") }}',
      dataType: 'json',
      delay: 250,
      data: function(params) {
        return {
          q: params.term, // search term
          in_stock: true // only show in-stock items
        };
      },
      processResults: function(data) {
        return {
          results: data.items
        };
      },
      cache: true
    }
  });

  // Show stock quantity when product is selected
  productSelect.on('change', function() {
    const productId = $(this).val();
    if (productId) {
      // Fetch stock information
      fetch(`/product-stock/${productId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            $('#stock-count').text(data.stock);
            $('#stock-indicator').removeClass('d-none');
            if (typeof data.price === 'number') {
              $('#list-price').text(Number(data.price).toFixed(2));
              $('#price-indicator').removeClass('d-none');
              // update placeholder to show default list price
              $('#unit_price').attr('placeholder', `${currencySymbol}${Number(data.price).toFixed(2)} (default)`);
              currentListPrice = Number(data.price);
            } else {
              $('#price-indicator').addClass('d-none');
              $('#unit_price').attr('placeholder', 'Leave blank to use list price');
              currentListPrice = null;
            }
            currentCost = (typeof data.cost === 'number') ? Number(data.cost) : null;
            
            // Update max quantity hint
            $('#max-quantity').text(data.stock);
            $('#max-quantity-hint').removeClass('d-none');
            
            // Update quantity field attributes
            const quantityField = $('#quantity');
            quantityField.attr('max', data.stock);
            
            // Validate current quantity value
            validateQuantity(quantityField.val(), data.stock);

            // Re-check below-cost state based on current input
            checkBelowCost();
          }
        });
    } else {
      $('#stock-indicator').addClass('d-none');
      $('#price-indicator').addClass('d-none');
      $('#unit_price').attr('placeholder', 'Leave blank to use list price');
      $('#max-quantity-hint').addClass('d-none');
      $('#below-cost-alert').addClass('d-none');
      currentCost = null;
      currentListPrice = null;
    }
  });

  // Validate quantity in real-time
  $('#quantity').on('input', function() {
    const stock = parseInt($('#max-quantity').text()) || 0;
    validateQuantity($(this).val(), stock);
  });

  // Form submission validation
  $('#sale-form').on('submit', function(e) {
    const quantity = parseInt($('#quantity').val()) || 0;
    const stock = parseInt($('#max-quantity').text()) || 0;
    
    if (quantity > stock) {
      e.preventDefault();
      $('#quantity-error').removeClass('d-none');
      $('#quantity').addClass('is-invalid');
    }
    // Prevent submit for cashiers if below-cost detected
    if (!canOverrideBelowCost && isBelowCost()) {
      e.preventDefault();
      $('#below-cost-alert').removeClass('d-none');
    }
    if (!e.isDefaultPrevented()) {
      $('#submit-btn').prop('disabled', true);
      $('#submit-btn .spinner-border').removeClass('d-none');
    }
  });

  // Helper function for quantity validation
  function validateQuantity(value, stock) {
    const quantity = parseInt(value) || 0;
    const errorElement = $('#quantity-error');
    const submitBtn = $('#submit-btn');
    
    if (quantity > stock) {
      errorElement.removeClass('d-none');
      $('#quantity').addClass('is-invalid');
      submitBtn.prop('disabled', true);
    } else {
      errorElement.addClass('d-none');
      $('#quantity').removeClass('is-invalid');
      // don't override below-cost triggered disable
      if (!(!canOverrideBelowCost && isBelowCost())) {
        submitBtn.prop('disabled', false);
      }
    }
  }

  // Below-cost helpers
  function isBelowCost() {
    if (currentCost == null) return false;
    const entered = parseFloat($('#unit_price').val());
    const effective = (isNaN(entered) || $('#unit_price').val().trim()==='')
      ? (currentListPrice !== null ? currentListPrice : 0)
      : entered;
    return effective < currentCost;
  }
  function checkBelowCost() {
    const alert = $('#below-cost-alert');
    if (isBelowCost()) {
      alert.removeClass('d-none');
      if (!canOverrideBelowCost) $('#submit-btn').prop('disabled', true);
    } else {
      alert.addClass('d-none');
      // enable only if quantity valid too
      if (!(!canOverrideBelowCost && (parseInt($('#quantity').val()) > (parseInt($('#max-quantity').text())||0)))) {
        $('#submit-btn').prop('disabled', false);
      }
    }
  }
  $('#unit_price').on('input', checkBelowCost);
});
</script>
{% endblock %}