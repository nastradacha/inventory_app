<div class="preview-container">
    <div class="alert alert-info">
        <strong>Preview Summary:</strong> 
        {{ valid_rows }} valid rows, {{ error_rows }} errors out of {{ total_rows }} total rows.
    </div>

    {% if errors %}
    <div class="alert alert-danger">
        <h6>Errors Found:</h6>
        <ul class="mb-0">
            {% for error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if results %}
    <div class="table-responsive">
        <table class="table table-sm table-hover">
            <thead class="table-light">
                <tr>
                    <th>Action</th>
                    <th>Product</th>
                    <th>Category</th>
                    <th>Cost Price</th>
                    <th>Selling Price</th>
                    <th>Stock Change</th>
                    <th>Safety Stock</th>
                    <th>Expiry</th>
                </tr>
            </thead>
            <tbody>
                {% for item in results %}
                <tr class="{% if item.action_type == 'create' %}table-success{% else %}table-warning{% endif %}">
                    <td>
                        {% if item.action_type == 'create' %}
                            <span class="badge bg-success">New</span>
                        {% else %}
                            <span class="badge bg-warning">Update</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ item.name }}</strong></td>
                    <td>{{ item.category }}</td>
                    <td>
                        {% if item.old_cost %}
                            <span class="text-decoration-line-through text-muted">GH₵{{ "%.2f"|format(item.old_cost) }}</span>
                            <br>
                        {% endif %}
                        <span class="text-success">GH₵{{ "%.2f"|format(item.cost_price) }}</span>
                    </td>
                    <td>
                        {% if item.old_selling %}
                            <span class="text-decoration-line-through text-muted">GH₵{{ "%.2f"|format(item.old_selling) }}</span>
                            <br>
                        {% endif %}
                        <span class="text-success">GH₵{{ "%.2f"|format(item.selling_price) }}</span>
                    </td>
                    <td>
                        {% if item.old_quantity %}
                            <span class="text-decoration-line-through text-muted">{{ item.old_quantity }}</span>
                            <i class="fas fa-arrow-right text-primary mx-1"></i>
                        {% endif %}
                        <span class="text-success">{{ item.new_quantity }}</span>
                    </td>
                    <td>{{ item.safety_stock }}</td>
                    <td>
                        {% if item.expiry_date %}
                            {{ item.expiry_date.strftime('%d/%m/%Y') }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <h6>Summary of Changes:</h6>
        <div class="row">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">{{ results|selectattr('action_type', 'equalto', 'create')|list|length }}</h5>
                        <p class="card-text">New Products</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">{{ results|selectattr('action_type', 'equalto', 'update')|list|length }}</h5>
                        <p class="card-text">Updated Products</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-info">{{ results|map(attribute='quantity')|map('int')|sum }}</h5>
                        <p class="card-text">Total Items</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">GH₵{{ "%.2f"|format(total_cost) }}</h5>
                        <p class="card-text">Total Cost</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="mt-3 d-flex justify-content-between">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-testid="cancel-preview">
            <i class="fas fa-times"></i> Cancel
        </button>
        <button id="confirmBtn" type="button" class="btn btn-success" data-testid="confirm-batch" onclick="confirmBatchUpload()">
            <span class="spinner-border spinner-border-sm d-none me-1" role="status" aria-hidden="true"></span>
            <i class="fas fa-check"></i> Confirm Changes
        </button>
    </div>

    <script id="updates-data" type="application/json" data-update-mode="{{ update_mode }}">
        {{ updates|tojson }}
    </script>

    <!-- confirmBatchUpload defined globally in batch_inventory.html -->
</script>
</div>
