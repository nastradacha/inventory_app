{% extends 'base.html' %}
{% block content %}
<h3>User Management</h3>
<table class="table table-sm"><thead><tr><th>Username</th><th>Role</th><th class="text-end">Reset&nbsp;Password</th><th class="text-end">Delete</th></tr></thead><tbody>
  {% for u in user_list %}
  <tr>
    <td>{{ u.username }}</td>
    <td>{{ u.role }}</td>
    <td class="text-end">
      <form action="{{ url_for('reset_pwd', user_id=u.id) }}" method="post" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-sm btn-warning" data-confirm="Reset password for {{ u.username }} to changeme123?" data-toggle="modal" data-target="#confirmModal">
          Reset â†’ changeme123
        </button>
        <input type="hidden" name="password" value="changeme123">
      </form>
    </td>
    <td class="text-end">
      {% if u.id != current_user.id %}
      <form action="{{ url_for('delete_user', user_id=u.id) }}" method="post" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-sm btn-outline-danger" data-confirm="Delete user {{ u.username }}? This cannot be undone." data-testid="delete-user-{{ u.id }}">
          Delete
        </button>
      </form>
      {% else %}
        <span class="text-muted small">You</span>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</tbody></table>
<hr>
<h4>Add New User</h4>
<form method="post" class="row g-3" novalidate id="user-form">
  {{ form.hidden_tag() }}
  <div class="col-md-4 form-floating">
    {{ form.username(class_='form-control' + (' is-invalid' if form.username.errors else ''), placeholder='Username') }}
    {{ form.username.label(class_='form-label') }}
    {% if form.username.errors %}<div class="text-danger small">{{ form.username.errors[0] }}</div>{% endif %}
  </div>
  <div class="col-md-4 form-floating">
    {{ form.password(class_='form-control' + (' is-invalid' if form.password.errors else ''), placeholder='Password') }}
    {{ form.password.label(class_='form-label') }}
    {% if form.password.errors %}<div class="text-danger small">{{ form.password.errors[0] }}</div>{% endif %}
  </div>
  <div class="col-md-4">
    {{ form.role.label(class_='form-label') }}
    {{ form.role(class_='form-select') }}
  </div>
  <div class="col-12"><button id="createBtn" class="btn btn-success" data-testid="save-user"><span class="spinner-border spinner-border-sm d-none me-1" role="status" aria-hidden="true"></span> Create User</button></div>
</form>
{% endblock %}
{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('user-form').addEventListener('submit', () => {
      const btn = document.getElementById('createBtn');
      btn.disabled = true;
      btn.querySelector('.spinner-border').classList.remove('d-none');
    });
  });
</script>
{% endblock %}