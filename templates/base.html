{% set is_mgr = current_user.is_authenticated and current_user.role == 'manager' %}
{% set is_cash = current_user.is_authenticated and current_user.role == 'cashier' %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>StoreTrack</title>

  <!-- CSS -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='mobile-responsive.css') }}" rel="stylesheet">
  <!-- Google Font: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Custom theme variables -->
  <link href="{{ url_for('static', filename='theme.css') }}" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary sticky-top">
  <div class="container-fluid">
    <button id="sidebarToggle" class="btn btn-primary me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
      <i class="bi bi-list fs-3"></i>
    </button>
    <a class="navbar-brand fw-bold" href="{{ url_for('dashboard') }}" data-testid="nav-dashboard">StoreTrack</a>
    <div class="ms-auto d-flex align-items-center gap-2">
      {% if is_cash %}
        {% if open_shift %}
          <span class="badge bg-info">{{ shift_qty }} / {{ currency }}{{ '{:,.2f'.format(shift_rev) }}</span>
        {% endif %}
      {% endif %}
      {% if current_user.is_authenticated %}
        <span class="text-white small">{{ current_user.username }}</span>
        <a class="text-white" href="{{ url_for('logout') }}" data-testid="logout"><i class="bi bi-box-arrow-right fs-5"></i></a>
      {% else %}
        <a class="text-white" href="{{ url_for('login') }}"><i class="bi bi-box-arrow-in-right fs-5"></i></a>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Offcanvas Sidebar -->
<div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="sidebar">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body p-0">
    <ul class="list-group list-group-flush">
      {% if current_user.is_authenticated %}
        <li class="list-group-item bg-dark border-0"><a class="text-white text-decoration-none" href="{{ url_for('record_sale') }}"><i class="bi bi-cash-stack me-2"></i>Record Sale</a></li>
        <li class="list-group-item bg-dark border-0"><a class="text-white text-decoration-none" href="{{ url_for('sales_list') }}"><i class="bi bi-receipt-cutoff me-2"></i>Sales</a></li>
      {% endif %}
      {% if is_mgr %}
        <li class="list-group-item bg-dark border-0"><a class="text-white text-decoration-none" href="{{ url_for('add_stock') }}"><i class="bi bi-plus-circle me-2"></i>Add Stock</a></li>
        <li class="list-group-item bg-dark border-0"><a class="text-white text-decoration-none" href="{{ url_for('batch_inventory.batch_inventory') }}"><i class="bi bi-upload me-2"></i>Batch Update</a></li>
        <li class="list-group-item bg-dark border-0"><a class="text-white text-decoration-none" href="{{ url_for('products') }}" data-testid="nav-products"><i class="bi bi-box-seam me-2"></i>Products</a></li>
        <li class="list-group-item bg-dark border-0"><a class="text-white text-decoration-none" href="{{ url_for('users') }}"><i class="bi bi-people me-2"></i>Users</a></li>
        <li class="list-group-item bg-dark border-0"><a class="text-white text-decoration-none" href="{{ url_for('shift_list') }}"><i class="bi bi-clock-history me-2"></i>Shifts</a></li>
        <li class="list-group-item bg-dark border-0"><a class="text-white text-decoration-none" href="{{ url_for('logs') }}"><i class="bi bi-list-check me-2"></i>Audit</a></li>
        <li class="list-group-item bg-dark border-0"><a class="text-white text-decoration-none" href="{{ url_for('settings') }}" data-testid="nav-settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
        <li class="list-group-item bg-dark border-0">
          <div class="dropdown">
            <a class="text-white text-decoration-none dropdown-toggle" href="#" id="reportDrop" data-bs-toggle="dropdown"><i class="bi bi-graph-up me-2"></i>Reports</a>
            <ul class="dropdown-menu dropdown-menu-dark">
              <li><a class="dropdown-item" href="{{ url_for('sales_summary') }}">Sales Summary</a></li>
              <li><a class="dropdown-item" href="{{ url_for('inventory_report') }}">Inventory Valuation</a></li>
            </ul>
          </div>
        </li>
      {% endif %}
    </ul>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container position-fixed top-0 end-0 p-3" data-testid="toast-container">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="toast align-items-center text-bg-{{ category if category!='message' else 'primary' }} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">{{ msg }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="container py-4">

  {% block content %}{% endblock %}
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{{ url_for('static', filename='barcode.js') }}"></script>
<script>
  // init Bootstrap toasts
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.toast').forEach(el => new bootstrap.Toast(el, {delay:4000}).show());
  });

  // Simple client-side error reporting utilities
  function shareError(kind, errId, extraText) {
    const version = "{{ app_version }}";
    const url = window.location.href;
    const ua = navigator.userAgent;
    const when = new Date().toISOString();
    const ownerEmail = "{{ owner_email or '' }}";
    const body = `StoreTrack error report\n`+
                 `Type: ${kind}\n`+
                 `ID: ${errId || 'N/A'}\n`+
                 `When: ${when}\n`+
                 `URL: ${url}\n`+
                 `App Version: ${version}\n`+
                 `UA: ${ua}\n`+
                 `${extraText?('Details: '+extraText+'\n'):''}`;
    const title = `StoreTrack Error ${errId||''}`.trim();

    if (navigator.share) {
      navigator.share({ title, text: body }).catch(()=>{});
      return;
    }
    // Desktop fallbacks: prefer email if configured
    if (ownerEmail) {
      const mailto = `mailto:${encodeURIComponent(ownerEmail)}?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
      return;
    }
    // WhatsApp / Telegram / SMS fallbacks could be added; default to copy
    navigator.clipboard.writeText(body).then(()=>{
      alert('Error details copied to clipboard. Paste into your email or chat.');
    }).catch(()=>{
      alert('Copy failed. Please take a screenshot and contact support.');
    });
  }

  // Global JS error capture
  window.addEventListener('error', (e) => {
    const msg = e?.message || 'Unknown error';
    if (confirm('An error occurred. Report this error?')) {
      shareError('client_js_error', null, msg);
    }
  });
  window.addEventListener('unhandledrejection', (e) => {
    const msg = (e?.reason && (e.reason.message || e.reason.toString())) || 'Unhandled promise rejection';
    if (confirm('A background error occurred. Report it?')) {
      shareError('client_promise_rejection', null, msg);
    }
  });
</script>
{% if app_env == 'Production' %}
  {% if current_user.is_authenticated and current_user.role=='manager' %}
    <footer class="text-center text-muted small py-2 d-none d-sm-block">
      <span>Version {{ app_version }} • {{ app_env }}</span>
      <span class="ms-2">|</span>
      <span class="ms-2">User: {{ current_user.username }}</span>
    </footer>
  {% endif %}
{% else %}
  <footer class="text-center text-muted small py-2 d-none d-sm-block">
    <span>Version {{ app_version }} • {{ app_env }}</span>
    {% if current_user.is_authenticated and current_user.role=='manager' %}
      <span class="ms-2">|</span>
      <span class="ms-2">User: {{ current_user.username }}</span>
    {% endif %}
  </footer>
{% endif %}
<!-- Reusable Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Please Confirm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmMessage">Are you sure?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmYesBtn">Yes, continue</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Confirmation modal logic
  document.addEventListener('DOMContentLoaded', () => {
    let targetForm = null;
    document.body.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-confirm]');
      if (!btn) return;
      e.preventDefault();
      targetForm = btn.closest('form');
      const msg = btn.dataset.confirm || 'Are you sure?';
      document.getElementById('confirmMessage').textContent = msg;
      bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmModal')).show();
    });
    document.getElementById('confirmYesBtn').addEventListener('click', () => {
      if (targetForm) targetForm.submit();
      bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
    });
  });
</script>

{% block scripts %}{% endblock %}
</body>
</html>
